<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>3D 自由互動天球</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/controls/OrbitControls.js"></script>
<style>
  body { margin:0; overflow:hidden; background:black; font-family:sans-serif; }
  #gui { position:absolute; top:10px; left:10px; color:white; z-index:10; }
  label { margin-right:5px; }
</style>
</head>
<body>
<div id="gui">
  緯度: <input type="range" id="lat" min="-90" max="90" value="25"> <span id="latVal">25</span>°<br>
  時間: <input type="range" id="time" min="0" max="24" value="0" step="0.1"> <span id="timeVal">0</span> h
</div>

<script>
// ===== 星表資料 =====
const stars = [
  {name:"天狼星", ra:101.2871554, dec:-16.71611583, color:0xadd8e6},
  {name:"參宿四", ra:88.79293875, dec:7.407062778, color:0xffa500},
  {name:"參宿七", ra:78.63458333, dec:-8.201666672, color:0x87ceeb},
  {name:"織女一", ra:279.23458335, dec:38.78361111, color:0xffffff},
  {name:"北極星", ra:37.95291667, dec:89.26416667, color:0xffff00},
  {name:"河鼓二", ra:297.6958292, dec:8.868321944, color:0xffffff},
  {name:"畢宿五", ra:68.98016279, dec:16.50930236, color:0xff4500},
  {name:"心宿二", ra:247.35, dec:-26.43194444, color:0xff0000},
  {name:"角宿一", ra:201.3982471, dec:-11.16132194, color:0xadd8e6},
  {name:"天津四", ra:310.3579167, dec:45.28027778, color:0xffffff}
];

// ===== Three.js 基本設定 =====
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 2000);
camera.position.set(0,0,800);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enablePan = false;
controls.minDistance = 100;
controls.maxDistance = 1000;

// ===== 星星物件 =====
const starGroup = new THREE.Group();
scene.add(starGroup);
const radius = 400; // 天球半徑

stars.forEach(s=>{
  const geom = new THREE.SphereGeometry(4,8,8);
  const mat = new THREE.MeshBasicMaterial({color:s.color});
  const mesh = new THREE.Mesh(geom, mat);
  mesh.userData = {ra:s.ra, dec:s.dec, name:s.name};
  starGroup.add(mesh);
});

// ===== 天球座標轉換函數 =====
function updateStars(lat, time){
  const rad = Math.PI/180;
  const latRad = lat*rad;
  const H0 = time*15*rad; // 基本時角
  starGroup.children.forEach(star=>{
    const ra = star.userData.ra * rad;
    const dec = star.userData.dec * rad;
    // 計算地平座標 (模擬東升西落)
    let H = H0 - ra;
    let alt = Math.asin(Math.sin(latRad)*Math.sin(dec) + Math.cos(latRad)*Math.cos(dec)*Math.cos(H));
    let az = Math.acos((Math.sin(dec)-Math.sin(alt)*Math.sin(latRad))/(Math.cos(alt)*Math.cos(latRad)));
    if(Math.sin(H)>0) az = 2*Math.PI - az;

    // 轉成天球球面座標 (3D)
    const r = radius;
    const x = r * Math.cos(alt) * Math.sin(az);
    const y = r * Math.sin(alt);
    const z = r * Math.cos(alt) * Math.cos(az);
    star.position.set(x,y,z);
  });
}

// ===== GUI 控制 =====
const latSlider = document.getElementById("lat");
const timeSlider = document.getElementById("time");
const latVal = document.getElementById("latVal");
const timeVal = document.getElementById("timeVal");

function update(){
  const lat = parseFloat(latSlider.value);
  const time = parseFloat(timeSlider.value);
  latVal.innerText = lat;
  timeVal.innerText = time;
  updateStars(lat,time);
}
latSlider.oninput = update;
timeSlider.oninput = update;

update();

// ===== 繪製 =====
function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

// ===== 視窗大小調整 =====
window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
